<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Status Request</title>

<style>
    :root{
        --blue:#000000;
        --card-bg:#FFFFFF;
        --radius:28px;
        --font:'Inter', sans-serif;
        --shadow:0 6px 18px rgba(0,0,0,0.16);

        --sus-yellow:#FFC319;

        --point-1-color:#6B7280;
        --point-2-color:#6B7280;
        --point-3-color:#6B7280;
        --point-4-color:#6B7280;

        --timeline-line-color:#CFCFCF;
        --timeline-text-color:#111111;
    }

    *{margin:0;padding:0;box-sizing:border-box;font-family:var(--font);}

    body{
        background:#0a53e4;
        min-height:100vh;
        display:flex;
        justify-content:center;
    }

    .container{
        width:min(420px,100%);
        background:var(--card-bg);
        margin-top:40px;
        padding:30px 24px;
        border-radius:var(--radius);
        box-shadow:var(--shadow);
        margin-bottom:40px;
    }

    .back-btn{
        font-size:26px;
        cursor:pointer;
        color:var(--blue);
        margin-bottom:10px;
    }

    .title{
        font-size:26px;
        font-weight:800;
        color:#000;
        margin-bottom:26px;
    }

    /* Card */
    .sus-card{
        background:var(--sus-yellow);
        border-radius:20px;
        padding:20px 20px;
        color:#111;
        display:flex;
        justify-content:space-between;
        align-items:center;
        box-shadow:0 10px 20px rgba(0,0,0,0.25);
        margin-bottom:40px;
    }

    .sus-title{
        font-size:22px;
        font-weight:700;
    }

    .sus-sub{
        font-size:14px;
        opacity:.9;
        margin-top:4px;
    }

    /* TIMELINE */
    .timeline{
        margin-left:25px;
        padding-left:10px;
    }

    .step-row{
        display:flex;
        align-items:center;
        margin-bottom:0px;
    }

    .point{
        width:18px;
        height:18px;
        border-radius:50%;
        margin-right:14px;
    }

    .p1,.p2,.p3,.p4{background:#6B7280;}

    .step-text{
        font-size:16px;
        color:var(--timeline-text-color);
    }

    .line{
        width:3px;
        height:50px;
        background:var(--timeline-line-color);
        margin-left:7px;
    }
</style>
</head>

<body>

<div class="container">

    <div class="back-btn" onclick="history.back()">‚Üê</div>

    <div class="title">Status Request</div>

    <!-- SUSTENANCE CARD -->
    <div class="sus-card">
        <div>
            <div class="sus-title">Request Sustenance</div>
            <div class="sus-sub">Food ‚Ä¢ Water ‚Ä¢ Medicine</div>
        </div>

        <!-- SVG ‡∏ñ‡∏∏‡∏á‡∏¢‡∏±‡∏á‡∏ä‡∏µ‡∏û -->
        <svg width="76" height="76" viewBox="0 0 24 24" fill="none">
            <path d="M3 8h18l-1 12H4L3 8z" fill="white"/>
            <path d="M8 8V6a4 4 0 018 0v2" stroke="white" stroke-width="2" stroke-linecap="round"/>
        </svg>
    </div>

    <!-- TIMELINE -->
    <div class="timeline">

        <div class="step-row">
            <div class="point p1"></div>
            <div class="step-text">Send a request for help</div>
        </div>

        <div class="line"></div>

        <div class="step-row">
            <div class="point p2"></div>
            <div class="step-text">Accept request</div>
        </div>

        <div class="line"></div>

        <div class="step-row">
            <div class="point p3"></div>
            <div class="step-text">Coming to help</div>
        </div>

        <div class="line"></div>

        <div class="step-row">
            <div class="point p4"></div>
            <div class="step-text">Succeed</div>
        </div>

    </div>

    <button id="btnSendRequest"
        style="
            width:100%;
            padding:16px;
            background:#FFC319;
            color:#111;
            font-size:18px;
            font-weight:700;
            border:none;
            border-radius:16px;
            margin-top:40px;
            box-shadow:0 6px 16px rgba(0,0,0,0.25);
            cursor:pointer;
        ">
        Send Request
    </button>

</div>

<script>
const API_BASE = "http://localhost:8080";

let ACTIVE_CASE_ID = null;
let TOKEN = null;

/* ===========================
   GET TOKEN
=========================== */
function getToken() {
    const urlToken = new URLSearchParams(window.location.search).get("token");

    if (urlToken) {
        localStorage.setItem("authToken", urlToken);
        return urlToken;
    }

    return localStorage.getItem("authToken");
}

/* ===========================
   UPDATE TIMELINE UI
=========================== */
function updateStatusUI(status) {

    console.log("üî∂ SUSTENANCE STATUS:", status);

    const colorActive = "#FFC319";   // active = yellow
    const colorOff = "#6B7280";      // inactive = gray

    const p1 = document.querySelector(".p1");
    const p2 = document.querySelector(".p2");
    const p3 = document.querySelector(".p3");
    const p4 = document.querySelector(".p4");

    const btn = document.getElementById("btnSendRequest");

    // Reset
    p1.style.background = colorOff;
    p2.style.background = colorOff;
    p3.style.background = colorOff;
    p4.style.background = colorOff;

    // Default = ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡πÄ‡∏Ñ‡∏™ ‚Üí ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°
    btn.disabled = true;
    btn.style.opacity = 0.6;
    btn.textContent = "Request Already Sent";

    if (status === "NEW") {
        p1.style.background = colorActive;
    }
    else if (status === "ASSIGNED") {
        p1.style.background = colorActive;
        p2.style.background = colorActive;
    }
    else if (status === "COMING") {
        p1.style.background = colorActive;
        p2.style.background = colorActive;
        p3.style.background = colorActive;
    }
    else if (status === "DONE") {
        p1.style.background = colorActive;
        p2.style.background = colorActive;
        p3.style.background = colorActive;
        p4.style.background = colorActive;

        // DONE ‚Üí ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å
        btn.disabled = false;
        btn.style.opacity = 1;
        btn.textContent = "Send Request";
    }
}

/* ===========================
   LOAD ACTIVE CASE
=========================== */
async function loadActiveCase() {

    TOKEN = getToken();

    const res = await fetch(`${API_BASE}/api/cases/my-active`, {
        headers: { "Authorization": "Bearer " + TOKEN }
    });

    if (res.status === 204) {
        console.log("‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏™ active");
        return;
    }

    if (!res.ok) {
        console.log("‡πÇ‡∏´‡∏•‡∏î active case ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        return;
    }

    const data = await res.json();

    console.log("ACTIVE SUSTENANCE CASE:", data);

    ACTIVE_CASE_ID = data.id;

    updateStatusUI(data.status);
}

/* ===========================
   AUTO REFRESH STATUS
=========================== */
async function refreshCaseStatus() {

    if (!ACTIVE_CASE_ID) return;

    const res = await fetch(`${API_BASE}/api/cases/${ACTIVE_CASE_ID}`, {
        headers: { "Authorization": "Bearer " + TOKEN }
    });

    if (!res.ok) return;

    const data = await res.json();
    updateStatusUI(data.status);
}

/* ===========================
   SEND SUSTENANCE REQUEST
=========================== */
document.getElementById("btnSendRequest").onclick = async () => {

    const TOKEN = getToken();

    const locRes = await fetch(`${API_BASE}/api/user-location/home`, {
        headers: { "Authorization": "Bearer " + TOKEN }
    });

    if (!locRes.ok) {
        alert("‚ö† ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô!");
        return;
    }

    const location = await locRes.json();

    const res = await fetch(`${API_BASE}/api/cases/report`, {
        method: "POST",
        headers: {
            "Authorization": "Bearer " + TOKEN,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            caseType: "SUSTENANCE",
            locationId: location.id
        })
    });

    if (!res.ok) {
        const err = await res.text();
        alert("‚ùå ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err);
        return;
    }

    const newCase = await res.json();
    ACTIVE_CASE_ID = newCase.id;

    alert("‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏¢‡∏±‡∏á‡∏ä‡∏µ‡∏û‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
};

/* ===========================
   INIT
=========================== */
document.addEventListener("DOMContentLoaded", () => {
    TOKEN = getToken();
    loadActiveCase();
    setInterval(refreshCaseStatus, 5000);
});
</script>



</body>
</html>
