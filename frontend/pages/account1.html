<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</title>
  <link rel="stylesheet" href="../css/account.css" />
</head>

<body>
  <header class="header">
    <svg onclick="window.history.back()" width="36" height="36" viewBox="0 0 36 36" fill="none"
      xmlns="http://www.w3.org/2000/svg">
      <path d="M11.7375 19.5L20.1375 27.9L18 30L6 18L18 6L20.1375 8.1L11.7375 16.5H30V19.5H11.7375Z" fill="white" />
    </svg>
    <h1>Account</h1>
  </header>

  <div class="content-container">
    <form id="accountForm">

      <label for="name">Name</label>
      <input type="text" id="name" name="name" placeholder="Enter your name" readonly>

      <label for="number">Phone Number</label>
      <input type="tel" id="number" name="phonenumber" readonly>

      <label for="address">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà / ‡∏´‡∏°‡∏π‡πà</label>
      <input type="text" id="address" name="address" readonly>

      <label for="tambon">‡∏ï‡∏≥‡∏ö‡∏•</label>
      <input type="text" id="tambon" name="tambon" readonly>

      <label for="amphoe">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label>
      <input type="text" id="amphoe" name="amphoe" readonly>

      <label for="zipcode">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</label>
      <input type="text" id="zipcode" name="zipcode" readonly>

      <label for="province">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
      <input type="text" id="province" name="province" readonly>

      <!-- <button type="submit" class="submit-btn">üíæ Confirm</button> -->
      <button type="button" class="signout-btn" onclick="logout()">Sign out</button>
    </form>
  </div>

  <script>
    // ‚úÖ ‡∏î‡∏∂‡∏á JWT ‡∏à‡∏≤‡∏Å localStorage
    const token = localStorage.getItem("jwt_token");
    if (!token) {
      alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô");
      window.location.href = "signin.html";
    }

    // ‚úÖ Decode JWT ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π phoneNumber
    function parseJwt(token) {
      try {
        return JSON.parse(atob(token.split('.')[1]));
      } catch (e) {
        console.error("Token decode failed:", e);
        return null;
      }
    }

    const decoded = parseJwt(token);
    const phoneNumber = decoded ? decoded.sub : null;

    if (!phoneNumber) {
      alert("‚ùå Token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
      window.location.href = "signin.html";
    }

    // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    async function loadUserDetail() {
      try {
        const res = await fetch(`http://localhost:8080/api/users/${phoneNumber}/detail`, {
          headers: { "Authorization": "Bearer " + token }
        });

        if (res.status === 401 || res.status === 403) {
          alert("‚õî Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà");
          localStorage.clear();
          window.location.href = "signin.html";
          return;
        }

        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        console.log("‚úÖ User detail:", data);

        document.getElementById("name").value = data.name || "";
        document.getElementById("number").value = phoneNumber;

      } catch (err) {
        console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
        alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ");
      }
    }

    // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
    async function loadUserAddress() {
      try {
        const res = await fetch("http://localhost:8080/api/address/my", {
          headers: { "Authorization": "Bearer " + token }
        });

        if (res.ok) {
          const data = await res.json();
          console.log("üè† Address:", data);
          console.log("üìÆ Postal Codes:", data.subdistrict?.postalCodes);

          document.getElementById("address").value = data.houseNumber || "";
          document.getElementById("tambon").value = data.subdistrict?.name || "";
          document.getElementById("amphoe").value = data.subdistrict?.district?.name || "";
          document.getElementById("province").value = data.subdistrict?.district?.province?.name || "";

          // ‚úÖ ‡∏î‡∏∂‡∏á‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå‡∏à‡∏≤‡∏Å array ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å
          const postalCode = data.subdistrict?.postalCodes?.[0]?.code;
          document.getElementById("zipcode").value = postalCode || "";

          console.log("‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå:", postalCode);
        } else {
          console.warn("‚ö†Ô∏è ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", res.status);
        }
      } catch (err) {
        console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
      }
    }

    // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∑‡πà‡∏≠ (PUT /api/users/detail)
    document.getElementById("accountForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const newName = document.getElementById("name").value.trim();

      if (!newName) {
        alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠");
        return;
      }

      try {
        const res = await fetch("http://localhost:8080/api/users/detail", {
          method: "PUT",
          headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ name: newName })
        });

        if (res.ok) {
          alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
          await loadUserDetail();
        } else if (res.status === 401 || res.status === 403) {
          alert("‚õî Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà");
          localStorage.clear();
          window.location.href = "signin.html";
        } else {
          alert("‚ùå ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }
      } catch (err) {
        console.error("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
      }
    });

    // ‚úÖ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
    function logout() {
      localStorage.clear();
      alert("üëã ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
      window.location.href = "signin.html";
    }

    // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
    (async () => {
      await loadUserDetail();
      setTimeout(loadUserAddress, 300); // ‡πÄ‡∏û‡∏¥‡πà‡∏° delay 0.3 ‡∏ß‡∏¥
      await loadUserAddress();
    })();
  </script>
</body>

</html>