<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Rescue Sign Up</title>
<style>
  :root{
    --blue:#0A53E4;
    --card:#FFFFFF;
    --label:#111827;
    --input-bg:#EDEFF2;
    --input-text:#111827;
    --green:#16A34A;
    --green-press:#12833C;
    --radius:14px;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--blue);
    display:flex;align-items:center;justify-content:center;
    padding:20px;
  }

  .card{
    width:100%;
    max-width:400px;
    background:var(--card);
    border-radius:12px;
    padding:28px 22px;
    box-shadow:0 10px 24px rgba(0,0,0,.18);
  }

  .title{
    text-align:center;
    font-weight:800;
    font-size:26px;
    margin-bottom:20px;
    color:#111827;
  }

  .field{margin-bottom:16px}
  label{
    display:block;
    font-size:14px;
    color:var(--label);
    margin:0 0 6px 2px;
  }
  input, select{
    width:100%;
    height:42px;
    border:none;
    outline:none;
    border-radius:8px;
    padding:0 12px;
    background:var(--input-bg);
    color:var(--input-text);
    font-size:15px;
  }

  .btn{
    width:100%;
    height:44px;
    border:none;outline:none;
    border-radius:8px;
    background:var(--green);
    color:#fff;
    font-weight:700;
    cursor:pointer;
    margin-top:10px;
    transition:background 0.2s;
  }
  .btn:active{ background:var(--green-press); }

  .hint{font-size:12px;color:#6B7280;margin-top:4px}
  .error{color:#DC2626;font-size:13px;margin-top:6px}
  .ok{color:#16A34A;font-size:13px;margin-top:6px}

  @media (max-width:480px){
    .card{padding:20px 16px;}
    .title{font-size:22px;margin-bottom:16px;}
    input,select{height:38px;font-size:14px;}
    .btn{height:40px;font-size:15px;}
  }

  @media (min-width:992px){
    body{padding:40px;}
    .card{
      max-width:420px;
      padding:34px 26px;
      border-radius:14px;
    }
    .title{font-size:28px;}
    input,select{height:46px;font-size:16px;}
    .btn{height:46px;font-size:16px;}
  }

  @media (min-width:481px) and (max-width:991px){
    .card{ max-width:380px; padding:28px 20px; }
    .title{font-size:24px;}
  }
</style>
</head>
<body>

<section class="card" role="form" aria-labelledby="title">
  <h1 id="title" class="title">Sign Up (Rescue)</h1>

  <div class="field">
    <label for="name">ชื่อ-นามสกุล</label>
    <input id="name" type="text" autocomplete="name" placeholder="เช่น นายสมชาย ใจดี">
  </div>

  <div class="field">
    <label for="phone">เบอร์โทรศัพท์</label>
    <input id="phone" type="tel" inputmode="numeric" maxlength="10" placeholder="เช่น 0812345678">
    <div class="hint">ต้องเป็นหมายเลข 10 หลัก (ขึ้นต้นด้วย 0)</div>
  </div>

  <div class="field">
    <label for="unit">หน่วยสังกัด</label>
    <select id="unit">
      <option value="">-- เลือกหน่วยสังกัด --</option>
    </select>
    <div class="hint" id="unit-hint">ดึงข้อมูลจากระบบอัตโนมัติ</div>
  </div>

  <button id="confirm" class="btn">Register</button>
  <div id="msg" aria-live="polite"></div>
</section>

<script>
// === CONFIG API ===
const RESCUE_API_BASE   = "http://localhost:8080/api/rescues";
const RESCUE_REGISTER   = RESCUE_API_BASE + "/register";
const UNITS_API         = "http://localhost:8080/api/units";

// เปลี่ยน path นี้ให้ตรงกับหน้า Sign In ของ rescue จริง ๆ ในโปรเจกต์
const RESCUE_SIGNIN_PAGE = "/pages/rescue-signin.html";

// === UI helper ===
function showMsg(text, type="error") {
  const el = document.getElementById("msg");
  el.className = type === "ok" ? "ok" : "error";
  el.textContent = text;
}

function validate(name, phone, unitId) {
  if (!name || name.trim().length < 2) return "กรุณากรอกชื่อให้ถูกต้อง";
  if (!/^0\d{9}$/.test(phone)) return "กรุณากรอกเบอร์โทร 10 หลักที่ถูกต้อง (เช่น 0812345678)";
  if (!unitId) return "กรุณาเลือกหน่วยสังกัด";
  return null;
}

// === โหลดรายการหน่วยจาก backend ===
async function loadUnits() {
  const select = document.getElementById("unit");
  const hint   = document.getElementById("unit-hint");

  try {
    hint.textContent = "กำลังโหลดรายชื่อหน่วยจากระบบ...";
    const res = await fetch(UNITS_API);
    if (!res.ok) {
      hint.textContent = "ไม่สามารถโหลดรายชื่อหน่วยได้";
      return;
    }
    const units = await res.json();

    // ล้าง option เดิม (เหลือแต่ตัวแรก)
    select.innerHTML = '<option value="">-- เลือกหน่วยสังกัด --</option>';

    if (!Array.isArray(units) || units.length === 0) {
      hint.textContent = "ยังไม่มีหน่วยในระบบ โปรดติดต่อผู้ดูแลระบบ";
      return;
    }

    for (const unit of units) {
      const opt = document.createElement("option");
      opt.value = unit.id;
      opt.textContent = unit.unitName;
      select.appendChild(opt);
    }

    hint.textContent = "เลือกรายการหน่วยที่คุณสังกัด";

  } catch (err) {
    console.error(err);
    hint.textContent = "เกิดข้อผิดพลาดในการโหลดรายชื่อหน่วย";
  }
}

// โหลดรายชื่อหน่วยทันทีเมื่อเปิดหน้า
document.addEventListener("DOMContentLoaded", loadUnits);

// === Handle Register ===
document.getElementById('confirm').addEventListener('click', async (e) => {
  e.preventDefault();

  const name   = document.getElementById('name').value.trim();
  const phone  = document.getElementById('phone').value.trim();
  const unitId = document.getElementById('unit').value;

  const err = validate(name, phone, unitId);
  if (err) { showMsg(err); return; }

  showMsg("กำลังสมัครสมาชิกกู้ภัย...", "ok");

  try {
    // JSON ตรงกับ RescueController.registerRescue(@RequestBody Rescue rescue)
    // - detail: name + phoneNumber
    // - affiliatedUnit: แค่ส่ง id ก็พอ (backend ไป findById เอง)
    const body = {
      detail: {
        name: name,
        phoneNumber: phone
      },
      affiliatedUnit: {
        id: Number(unitId)
      }
      // ถ้าวันหน้าต้องเลือกทีมเพิ่ม ค่อยแนบ rescueTeam: { id: ... } เข้าไป
    };

    const regRes = await fetch(RESCUE_REGISTER, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });

    const regJson = await regRes.json().catch(() => ({}));

    if (!regRes.ok) {
      const msg = regJson?.message || regJson?.error || "สมัครกู้ภัยไม่สำเร็จ";
      showMsg("สมัครกู้ภัยไม่สำเร็จ: " + msg);
      return;
    }

    // ส่วนใหญ่ backend จะส่ง message + rescueId กลับมา
    const rescueId = regJson?.rescueId;
    if (rescueId) {
      showMsg(`สมัครสำเร็จ! รหัสกู้ภัยของคุณคือ ${rescueId} กำลังกลับไปหน้าเข้าสู่ระบบ...`, "ok");
    } else {
      showMsg("สมัครสำเร็จ! กำลังกลับไปหน้าเข้าสู่ระบบ...", "ok");
    }

    setTimeout(() => {
      window.location.href = RESCUE_SIGNIN_PAGE;
    }, 1500);

  } catch (err) {
    console.error(err);
    showMsg("เกิดข้อผิดพลาดในการเชื่อมต่อเซิร์ฟเวอร์");
  }
});
</script>

</body>
</html>
