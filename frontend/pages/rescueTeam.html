<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rescue Team</title>

    <style>
        body {
            font-family: Inter, sans-serif;
            background: #d81324;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 430px;
            background: white;
            min-height: 100vh;
            border-radius: 20px 20px 0 0;
            overflow: hidden;
        }

        .header {
            background: #0A53E4;
            padding: 20px;
            color: #fff;
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            position: relative;
        }

        .back-btn {
            position: absolute;
            left: 16px;
            top: 20px;
            font-size: 20px;
            cursor: pointer;
        }

        .content {
            padding: 20px;
        }

        .search-box {
            width: 100%;
            display: flex;
            border: 1px solid #ccc;
            border-radius: 10px;
            background: #fff;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .search-box input {
            flex: 1;
            padding: 10px;
            border: none;
        }

        .search-box button {
            background: none;
            border: none;
            padding: 10px 14px;
            cursor: pointer;
            font-size: 18px;
        }

        .team-create {
            margin-top: 18px;
            border: 1px solid #222;
            padding: 12px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 16px;
        }

        .team-create span {
            font-size: 22px;
        }

        .team-card {
            border: 1px solid #ddd;
            padding: 14px;
            border-radius: 12px;
            margin-bottom: 14px;
            background: #f5f5f5;
        }

        .my-team {
            background: #dcecff;
            border-color: #0A53E4;
        }

        .t-head {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 16px;
        }

        .t-sub {
            font-size: 14px;
            color: #444;
        }
    </style>
</head>

<body>
    <div class="container">

        <div class="header">
            <span class="back-btn" onclick="goBack()">‚Üê</span>
            Rescue team
        </div>

        <div class="content">

            <!-- Search Team -->
            <div class="search-box">
                <input id="teamIdInput" type="text" placeholder="Team ID: 12345" />
                <button onclick="searchTeam()">üîç</button>
            </div>

            <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
            <div id="teamList"></div>

            <!-- ‡∏õ‡∏∏‡πà‡∏° Create Team -->
            <div id="createTeamBox" class="team-create" onclick="goToCreateTeam()" style="display:none;">
                <span>‚ûï</span> Team
            </div>

        </div>
    </div>

    <script>
        const API_BASE = "http://localhost:8080";

        const token = localStorage.getItem("authToken");
        const rescueDbId = localStorage.getItem("rescueDbId");

        if (!token || !rescueDbId) {
            window.location.href = "/pages/signin.html?error=need_login";
        }

        function goBack() {
            window.location.href = `/pages/homeRescue.html?token=${encodeURIComponent(token)}`;
        }

        function goToCreateTeam() {
            window.location.href = `/pages/createTeam.html?token=${encodeURIComponent(token)}`;
        }

        /* ----------------------------------------------------------
           ‚≠ê ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        ----------------------------------------------------------- */
        async function loadAllTeams() {
            const res = await fetch(`${API_BASE}/api/rescue-teams`, {
                headers: { Authorization: "Bearer " + token }
            });
            return await res.json();
        }

        /* ----------------------------------------------------------
           ‚≠ê ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏≠‡∏á
        ----------------------------------------------------------- */
        async function loadMyTeam() {
            const res = await fetch(`${API_BASE}/api/rescues/main/${rescueDbId}`, {
                headers: { Authorization: "Bearer " + token }
            });
            return await res.json();
        }

        /* ----------------------------------------------------------
           ‚≠ê ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡∏°‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á + ‡∏ó‡∏µ‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÜ
        ----------------------------------------------------------- */
        async function initTeams() {
            const my = await loadMyTeam();
            const allTeams = await loadAllTeams();

            const container = document.getElementById("teamList");
            container.innerHTML = "";

            //--- ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å backend ----
            const myTeamInfo = my.teamInfo || null;
            const myTeamId = my.teamInfo?.teamId || null;
            const myTeamName = myTeamInfo?.teamName || null;
            const myDistrict = my.districtName || "-";
            const myIsLeader = my.isLeader || false;

            /* ----------------------------------------------------------
               üîµ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ó‡∏µ‡∏° ‚Üí ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡∏° + ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ö‡∏ô‡∏™‡∏∏‡∏î
            ----------------------------------------------------------- */
            if (myTeamId) {
                document.getElementById("createTeamBox").style.display = "none";

                const box = document.createElement("div");
                box.className = "team-card my-team";

                box.innerHTML = `
                    <div class="t-head">
                        <span><b>Team :</b> ${myTeamName}</span>
                        <span><b>ID :</b> ${myTeamId}</span>
                    </div>
                    <div class="t-sub">
                        Rescue Team ${myIsLeader ? "Leader" : "Member"}<br>
                        ${myTeamInfo.leader}
                    </div>
                `;

                box.addEventListener("click", () => {
                    window.location.href =
                        `/pages/viewTeam.html?token=${encodeURIComponent(token)}` +
                        `&teamId=${myTeamId}` +
                        `&district=${encodeURIComponent(myDistrict)}` +
                        `&isLeader=${myIsLeader}`;
                });

                container.appendChild(box);
            } else {
                // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡∏°: ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡∏°
                document.getElementById("createTeamBox").style.display = "flex";
            }

            /* ----------------------------------------------------------
               üîµ ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÜ
            ----------------------------------------------------------- */
            allTeams.forEach(team => {
                if (team.teamId === myTeamId) return;

                const item = document.createElement("div");
                item.className = "team-card";

                item.innerHTML = `
                    <div class="t-head">
                        <span><b>Team :</b> ${team.name}</span>
                        <span><b>ID :</b> ${team.teamId}</span>
                    </div>
                    <div class="t-sub">
                        Rescue Team Leader<br>
                        ${team.leader?.detail?.name ?? "-"}
                    </div>
                `;

                // ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏î‡∏ó‡∏µ‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏î‡πâ
                item.style.opacity = "0.6";
                item.style.cursor = "not-allowed";

                container.appendChild(item);
            });
        }

        /* ----------------------------------------------------------
           üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Team (‡∏Å‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á)
        ----------------------------------------------------------- */
        async function searchTeam() {
            const inputId = document.getElementById("teamIdInput").value.trim();

            if (!inputId) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Team ID");
                return;
            }

            const url = `${API_BASE}/api/rescue-teams/${inputId}/members/${localStorage.getItem("rescueId")}`;
            const res = await fetch(url, {
                headers: { Authorization: "Bearer " + token }
            });

            if (res.status === 403) {
                alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏µ‡∏°‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ (‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ó‡∏µ‡∏°)");
                return;
            }

            if (!res.ok) {
                alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤");
                return;
            }

            const data = await res.json();

            window.location.href =
                `/pages/viewTeam.html?token=${encodeURIComponent(token)}` +
                `&teamId=${inputId}` +
                `&district=${encodeURIComponent(data.district)}` +
                `&isLeader=${data.isViewerLeader}`;
        }

        /* ----------------------------------------------------------
           üî• Init Page
        ----------------------------------------------------------- */
        initTeams();

    </script>

</body>

</html>
