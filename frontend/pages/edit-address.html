<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</title>
    <link rel="stylesheet" href="../css/style.css" />
</head>

<body>
    <header>
        <div class="back" onclick="goBackHome()">
            <svg width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M11.7375 19.5L20.1375 27.9L18 30L6 18L18 6L20.1375 8.1L11.7375 16.5H30V19.5H11.7375Z"
                    fill="#FEF7FF" />
            </svg>
        </div>
        <h1>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h1>
    </header>

    <main class="form-container">
        <form id="editAddressForm" onsubmit="updateAddress(event)">

            <label for="houseNumber">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà <span style="color:red;">*</span></label>
            <input type="text" id="houseNumber" placeholder="‡πÄ‡∏ä‡πà‡∏ô 12/3 ‡∏´‡∏°‡∏π‡πà 5 ‡∏ö‡πâ‡∏≤‡∏ô‡∏î‡∏≠‡∏¢‡∏´‡∏•‡∏ß‡∏á..." required />

            <label for="moreDetails">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
            <textarea id="moreDetails" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏î‡∏®‡∏£‡∏µ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå ‡∏ï‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡πÅ‡∏ü..."></textarea>

            <label for="province">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
            <select id="province" required>
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î --</option>
            </select>

            <label for="district">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label>
            <select id="district" required disabled>
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ --</option>
            </select>

            <label for="subdistrict">‡∏ï‡∏≥‡∏ö‡∏•</label>
            <select id="subdistrict" required disabled>
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏• --</option>
            </select>

            <label for="postalCode">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</label>
            <select id="postalCode" required disabled>
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå --</option>
            </select>

            <button type="submit" class="save-btn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
        </form>
    </main>

    <script>
        // ‚úÖ ‡∏ñ‡∏≠‡∏î token ‡∏à‡∏≤‡∏Å URL ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô localStorage ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
        const params = new URLSearchParams(window.location.search);
        const urlToken = params.get("token");
        if (urlToken) {
            localStorage.setItem("jwt_token", urlToken);
        }

        // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö JWT token ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤
        const token = localStorage.getItem("jwt_token");
        if (!token) {
            alert("‚õî Access Denied: Token not provided\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà");
            window.location.href = "../pages/signin.html";
        }

        // ‚úÖ ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Element
        const provinceSelect = document.getElementById("province");
        const districtSelect = document.getElementById("district");
        const subdistrictSelect = document.getElementById("subdistrict");
        const postalSelect = document.getElementById("postalCode");
        const houseInput = document.getElementById("houseNumber");
        const detailInput = document.getElementById("moreDetails");

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ö JWT ‡∏ó‡∏∏‡∏Å request
        async function apiFetch(url, options = {}) {
            const headers = options.headers || {};
            headers["Authorization"] = "Bearer " + token;
            headers["Content-Type"] = "application/json";
            return fetch(url, { ...options, headers });
        }

        // -------------------------------
        // üîπ ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        // -------------------------------
        async function loadProvinces() {
            const res = await apiFetch("http://localhost:8080/api/location/provinces");
            if (!res.ok) return alert("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            const provinces = await res.json();
            provinceSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î --</option>';
            provinces.forEach(p => {
                const opt = document.createElement("option");
                opt.value = p.id;
                opt.textContent = p.name || p.provinceName;
                provinceSelect.appendChild(opt);
            });
        }

        // -------------------------------
        // üîπ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        // -------------------------------
        async function loadMyAddress() {
            try {
                const res = await apiFetch("http://localhost:8080/api/address/my");
                if (res.status === 401 || res.status === 403) {
                    alert("‚õî Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà");
                    localStorage.clear();
                    window.location.href = "../pages/signin.html";
                    return;
                }

                if (res.ok) {
                    const data = await res.json();
                    console.log("‚úÖ My address:", data);

                    houseInput.value = data.houseNumber || "";
                    detailInput.value = data.moreDetails || "";

                    const sub = data.subdistrict;
                    if (sub && sub.district && sub.district.province) {
                        await loadProvinces();
                        provinceSelect.value = sub.district.province.id;
                        await loadDistricts(sub.district.province.id);
                        districtSelect.value = sub.district.id;
                        await loadSubdistricts(sub.district.id);
                        subdistrictSelect.value = sub.id;
                        await loadPostals(sub.id);
                    }
                } else if (res.status === 404) {
                    alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì");
                    await loadProvinces();
                } else {
                    throw new Error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà");
                }
            } catch (err) {
                console.error(err);
                alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏î‡πâ");
            }
        }

        // -------------------------------
        // üîπ ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏≥‡πÄ‡∏†‡∏≠
        // -------------------------------
        async function loadDistricts(provinceId) {
            const res = await apiFetch(`http://localhost:8080/api/location/districts/${provinceId}`);
            const districts = await res.json();
            districtSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ --</option>';
            districts.forEach(d => {
                const opt = document.createElement("option");
                opt.value = d.id;
                opt.textContent = d.name || d.districtName;
                districtSelect.appendChild(opt);
            });
            districtSelect.disabled = false;
        }

        // -------------------------------
        // üîπ ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≥‡∏ö‡∏•
        // -------------------------------
        async function loadSubdistricts(districtId) {
            const res = await apiFetch(`http://localhost:8080/api/location/subdistricts/${districtId}`);
            const subs = await res.json();
            subdistrictSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏• --</option>';
            subs.forEach(s => {
                const opt = document.createElement("option");
                opt.value = s.id;
                opt.textContent = s.name || s.subdistrictName;
                subdistrictSelect.appendChild(opt);
            });
            subdistrictSelect.disabled = false;
        }

        // -------------------------------
        // üîπ ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå
        // -------------------------------
        async function loadPostals(subdistrictId) {
            const res = await apiFetch(`http://localhost:8080/api/location/postal/${subdistrictId}`);
            const postals = await res.json();
            postalSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå --</option>';
            postals.forEach(p => {
                const opt = document.createElement("option");
                opt.value = p.id;
                opt.textContent = p.code || p.postalCode;
                postalSelect.appendChild(opt);
            });
            postalSelect.disabled = false;
        }

        // -------------------------------
        // üîπ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‚Üí ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏≥‡πÄ‡∏†‡∏≠
        // -------------------------------
        provinceSelect.addEventListener("change", async () => {
            const id = provinceSelect.value;
            if (id) await loadDistricts(id);
        });

        // -------------------------------
        // üîπ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‚Üí ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≥‡∏ö‡∏•
        // -------------------------------
        districtSelect.addEventListener("change", async () => {
            const id = districtSelect.value;
            if (id) await loadSubdistricts(id);
        });

        // -------------------------------
        // üîπ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏• ‚Üí ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå
        // -------------------------------
        subdistrictSelect.addEventListener("change", async () => {
            const id = subdistrictSelect.value;
            if (id) await loadPostals(id);
        });

        // -------------------------------
        // üîπ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (PUT /api/address/update)
        // -------------------------------
        async function updateAddress(event) {
            event.preventDefault();

            const subdistrictId = subdistrictSelect.value;
            const houseNumber = houseInput.value.trim();

            if (!houseNumber || !subdistrictId) {
                alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
                return;
            }

            const payload = {
                houseNumber: houseNumber,
                moreDetails: detailInput.value.trim(),
                subdistrict: { id: subdistrictId }
            };

            const res = await apiFetch("http://localhost:8080/api/address/update", {
                method: "PUT",
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à token ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ home
                const checkToken = localStorage.getItem("jwt_token");
                if (!checkToken) {
                    alert("‚ö†Ô∏è Session ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà");
                    window.location.href = "signin.html";
                    return;
                }

                // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ home
                alert("‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏û‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å");

                // ‚úÖ redirect ‡∏û‡∏£‡πâ‡∏≠‡∏° token (‡∏Å‡∏±‡∏ô cache/refresh ‡∏õ‡∏±‡∏ç‡∏´‡∏≤)
                window.location.href = `home.html?token=${encodeURIComponent(checkToken)}`;
            } else {
                const errMsg = await res.text();
                alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏î‡πâ\n" + errMsg);
            }
        }

        // ‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
        loadMyAddress();

        function goBackHome() {
            const token = localStorage.getItem("jwt_token");
            if (!token) {
                alert("‚õî Access Denied: Token not provided\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà");
                window.location.href = "../pages/signin.html";
                return;
            }

            // ‚úÖ ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ home ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ô‡∏ö token
            window.location.href = `home.html?token=${encodeURIComponent(token)}`;
        }
    </script>
</body>

</html>