<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sign in</title>
<style>
  :root{
    --blue:#0A53E4;
    --red:#B80000;
    --card:#FFFFFF;
    --label:#111827;
    --input-bg:#EDEFF2;
    --input-text:#111827;
    --green:#16A34A;
    --green-press:#12833C;
  }

  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}

  body{
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--blue); /* เริ่มต้นเป็น user = ฟ้า */
    display:flex;
    align-items:center;
    justify-content:center;
    padding:20px;
    transition:background 0.3s ease;
  }

  .card{
    width:100%;
    max-width:400px;
    background:var(--card);
    border-radius:20px;
    padding:32px 26px 20px;
    box-shadow:0 12px 28px rgba(0,0,0,.18);
  }

  .title{
    text-align:center;
    font-weight:800;
    font-size:28px;
    margin-bottom:20px;
    color:#111827;
  }

  .field{margin-bottom:16px}
  label{
    display:block;
    font-size:14px;
    color:var(--label);
    margin:0 0 6px 2px;
  }
  input{
    width:100%;
    height:42px;
    border:none;
    outline:none;
    border-radius:10px;
    padding:0 12px;
    background:var(--input-bg);
    color:var(--input-text);
    font-size:15px;
  }

  .role-toggle{
    display:flex;
    justify-content:center;
    gap:16px;
    margin-bottom:14px;
    font-size:14px;
  }
  .role-toggle label{
    display:flex;
    align-items:center;
    gap:4px;
    cursor:pointer;
  }

  .btn{
    width:100%;
    height:44px;
    border:none;outline:none;
    border-radius:10px;
    background:var(--green);
    color:#fff;
    font-weight:700;
    cursor:pointer;
    margin-top:8px;
    transition:background 0.2s;
  }
  .btn:active{ background:var(--green-press); }

  .error{color:#DC2626;font-size:13px;margin-top:6px}
  .ok{color:#16A34A;font-size:13px;margin-top:6px}

  .links{
    display:flex;
    justify-content:space-between;
    font-size:13px;
    margin-top:18px;
    padding:0 4px 4px;
  }
  .links a{
    text-decoration:none;
    color:#111827;
  }
  .links a:hover{text-decoration:underline;}

  @media (max-width:480px){
    .card{padding:24px 18px 18px;}
    .title{font-size:24px;}
    input{height:38px;font-size:14px;}
    .btn{height:40px;font-size:15px;}
  }
</style>
</head>
<body>

<section class="card" role="form" aria-labelledby="title">
  <h1 id="title" class="title">Sign in</h1>

  <!-- เลือกว่าจะล็อกอินเป็น User หรือ Rescue -->
  <div class="role-toggle">
    <label><input type="radio" name="role" value="USER" checked> User</label>
    <label><input type="radio" name="role" value="RESCUE"> Rescue</label>
  </div>

  <div class="field">
    <label for="name">Name</label>
    <input id="name" type="text" autocomplete="name" placeholder="เช่น นายสมชาย ใจดี">
  </div>

  <div class="field">
    <label for="phone">Number</label>
    <input id="phone" type="tel" inputmode="numeric" maxlength="10" placeholder="เช่น 0812345678">
  </div>

  <button id="confirm" class="btn">Confirm</button>
  <div id="msg" aria-live="polite"></div>

  <div class="links">
  <a href="/pages/signupUser.html">User Sign up</a>
  <a href="/pages/signupRescue.html">Rescue Sign up</a>
</div>

</section>

<script>
    const USER_LOGIN_API = "http://localhost:8080/api/users/login";
    const RESCUE_LOGIN_API = "http://localhost:8080/api/rescues/login";

    const HOME_USER_PAGE = "/pages/homeUser.html";
    const HOME_RESCUE_PAGE = "/pages/homeRescue.html";

    function extractToken(j) {
      return j.token || j.jwt || j.accessToken || null;
    }

    function showMsg(msg, type = "error") {
      const el = document.getElementById("msg");
      el.className = type;
      el.textContent = msg;
    }

    function getRole() {
      return document.querySelector("input[name='role']:checked").value;
    }

    document.getElementById("confirm").addEventListener("click", async e => {
      e.preventDefault();

      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const role = getRole();

      if (!name || !phone) {
        showMsg("กรุณากรอกข้อมูลให้ครบ");
        return;
      }

      showMsg("กำลังเข้าสู่ระบบ...", "ok");

      const url = (role === "USER") ? USER_LOGIN_API : RESCUE_LOGIN_API;

      const bodyObj = {
        name: name,
        phone_number: phone
      };

      try {
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(bodyObj)
        });

        const json = await res.json().catch(() => ({}));

        if (!res.ok) {
          showMsg(json.message || "เข้าสู่ระบบไม่สำเร็จ");
          return;
        }

        const token = extractToken(json);
        if (!token) {
          showMsg("เซิร์ฟเวอร์ไม่ได้ส่ง token มา");
          return;
        }

        // ⭐ Save Token + Role
        localStorage.setItem("authToken", token);
        localStorage.setItem("authRole", role);

        // ⭐ Save Rescue Info (เพื่อใช้ในหน้า Account / Menu / Header)
        if (role === "RESCUE") {
          localStorage.setItem("rescueDbId", json.rescueDbId);  // PK
          localStorage.setItem("rescueId", json.rescueId);      // RS-024
          localStorage.setItem("rescueName", json.name);        // ชื่อ
          localStorage.setItem("rescueUnit", json.unit);        // หน่วย
        }

        showMsg("สำเร็จ! กำลังนำทาง...", "ok");

        const goto = (role === "USER") ? HOME_USER_PAGE : HOME_RESCUE_PAGE;
    

        setTimeout(() => {
          window.location.href = `${goto}?token=${encodeURIComponent(token)}`;
        }, 800);

      } catch (err) {
        console.error(err);
        showMsg("เชื่อมต่อเซิร์ฟเวอร์ไม่ได้");
      }
    });
  </script>


</body>
</html>