<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>View Team</title>
  <style>
    :root {
      --blue: #0A53E4;
      --red: #D81324;
      --row: #E5E7EB;
      --card: #FFFFFF;
      --green: #16A34A;
      --danger: #DC2626;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box
    }

    body {
      font-family: Inter, system-ui, -apple-system, "Segoe UI", sans-serif;
      background: var(--red);
      display: flex;
      justify-content: center;
      padding: 24px 12px;
    }

    .phone {
      width: 100%;
      max-width: 440px;
      border-radius: 26px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
      min-height: 640px;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .header {
      background: var(--blue);
      color: #fff;
      padding: 14px 20px 18px;
      position: relative;
    }

    .header-title {
      text-align: center;
      font-weight: 700;
      font-size: 22px;
    }

    .back {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
      cursor: pointer;
    }

    .header-sub {
      margin-top: 4px;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      padding: 0 4px;
    }

    .body {
      flex: 1;
      padding: 18px 20px 24px;
    }

    .member-header {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 10px;
      align-items: center;
    }

    .add-btn {
      font-size: 13px;
      padding: 6px 10px;
      border-radius: 6px;
      background: var(--blue);
      color: #fff;
      cursor: pointer;
    }

    .delete-team-btn {
      margin-top: 20px;
      width: 100%;
      padding: 10px;
      background: var(--danger);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      cursor: pointer;
    }

    .member-list {
      margin-top: 6px;
    }

    .row {
      background: var(--row);
      border-radius: 8px;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .row-main {
      display: flex;
      flex-direction: column;
      font-size: 13px;
    }

    .row-main span:first-child {
      font-weight: 600;
    }

    .aff-name {
      font-size: 12px;
      opacity: .7;
    }

    .row-action {
      cursor: pointer;
      padding: 4px 6px;
      font-size: 18px;
      color: #555;
    }

    .row-action.disabled {
      opacity: .2;
      cursor: default;
    }

    .msg {
      margin-top: 10px;
      font-size: 13px;
    }

    .msg.error {
      color: var(--danger);
    }

    .msg.ok {
      color: var(--green);
    }

    /* Modal background */
    .modal-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, .35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    .modal-overlay.show {
      display: flex;
    }

    /* Popup ‡∏Ç‡∏ô‡∏≤‡∏î‡∏û‡∏≠‡∏î‡∏µ‡∏à‡∏≠ (‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÑ‡∏î‡πâ) */
    .modal {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      width: 90%;
      max-width: 360px;
      max-height: 80vh;
      /* üî• ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ï‡∏≤‡∏°‡∏à‡∏≠ */
      display: flex;
      flex-direction: column;
    }

    .modal h3 {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    /* ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô popup ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô scroll ‡πÑ‡∏î‡πâ */
    #candidateList {
      flex: 1;
      /* ‡∏î‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏Å‡∏¥‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà */
      overflow-y: auto;
      /* üî• ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏•‡∏á‡πÑ‡∏î‡πâ */
      padding-right: 4px;
      margin-bottom: 12px;
      max-height: 55vh;
      /* ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
    }

    .user-item {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      text-align: left;
    }

    .user-item:hover {
      background: #f3f3f3;
    }

    /* ‡∏õ‡∏∏‡πà‡∏°‡∏•‡πà‡∏≤‡∏á */
    .btn-sm {
      padding: 10px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-cancel {
      background: #ddd;
      width: 100%;
    }

    .btn-add {
      background: var(--green);
      color: #fff;
      width: 100%;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <div class="phone">
    <div class="header">
      <span class="back" id="backBtn">‚Üê</span>
      <div class="header-title">Team</div>
      <div class="header-sub">
        <span>District: <span id="districtLabel">-</span></span>
        <span>ID: <span id="teamIdLabel">-</span></span>
      </div>
    </div>

    <div class="body">
      <div class="member-header">
        <span>Member</span>
        <span id="addBtn" class="add-btn" style="display:none;">+ Add</span>
      </div>

      <div id="memberList" class="member-list"></div>
      <div id="msg" class="msg"></div>

      <button id="deleteTeamBtn" class="delete-team-btn" style="display:none;">
        Delete Team
      </button>
    </div>

    <!-- Modal Add Member -->
    <div id="modalOverlay" class="modal-overlay">
      <div class="modal">
        <h3>Select Member</h3>
        <div id="candidateList"></div>
        <button class="btn-sm btn-cancel" id="closeModal">Cancel</button>
      </div>
    </div>

    <!-- Modal ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô -->
    <div id="confirmOverlay" class="modal-overlay">
      <div class="modal" style="max-width:300px;">
        <h3 id="confirmMessage">Are you sure?</h3>
        <button id="confirmYes" class="btn-sm btn-add">Yes</button>
        <button id="confirmNo" class="btn-sm btn-cancel">Cancel</button>
      </div>
    </div>

  </div>

  <script>
    const API_BASE = "http://localhost:8080";

    /* ---------------------------------------
       1)  Sync Token
    ----------------------------------------*/
    (function syncTokenFromUrl() {
      const p = new URLSearchParams(window.location.search);
      const t = p.get("token");
      if (t) localStorage.setItem("authToken", t);
    })();

    const token = localStorage.getItem("authToken");
    const rescueDbId = localStorage.getItem("rescueDbId");
    let currentRescueId = localStorage.getItem("rescueId") || null;

    if (!token || !rescueDbId) {
      window.location.href = "/pages/signin.html?error=need_login";
    }

    /* ---------------------------------------
       2) Read URL params
    ----------------------------------------*/
    const params = new URLSearchParams(window.location.search);
    const teamId = params.get("teamId");
    const district = params.get("district") || "-";

    document.getElementById("districtLabel").textContent = district;
    document.getElementById("teamIdLabel").textContent = teamId;

    /* ---------------------------------------
       Back Button
    ----------------------------------------*/
    document.getElementById("backBtn").addEventListener("click", () => {
      window.location.href =
        "/pages/rescueTeam.html?token=" + encodeURIComponent(token);
    });

    /* ---------------------------------------
       Common message display
    ----------------------------------------*/
    function showMsg(t, isError) {
      const el = document.getElementById("msg");
      el.textContent = t;
      el.className = "msg " + (isError ? "error" : "ok");
    }

    /* ---------------------------------------
       Ensure rescueId
    ----------------------------------------*/
    async function ensureCurrentRescueId() {
      if (currentRescueId) return currentRescueId;

      const r = await fetch(`${API_BASE}/api/rescues/main/${rescueDbId}`, {
        headers: { Authorization: "Bearer " + token },
      });

      const d = await r.json();
      currentRescueId = d.rescueId;
      localStorage.setItem("rescueId", currentRescueId);
      return currentRescueId;
    }

    /* ---------------------------------------
   Render Member List (‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡∏°‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î + ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©)
----------------------------------------*/
    function renderMembers(data) {
      const list = document.getElementById("memberList");
      list.innerHTML = "";

      let members = data.members;
      const isLeader = data.isViewerLeader;

      // ‚≠ê ‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡∏°‡πÑ‡∏õ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î
      members.sort((a, b) => {
        if (a.isLeader && !b.isLeader) return -1;
        if (!a.isLeader && b.isLeader) return 1;
        return 0;
      });

      // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡∏°
      document.getElementById("addBtn").style.display = isLeader ? "inline-block" : "none";
      document.getElementById("deleteTeamBtn").style.display = isLeader ? "block" : "none";

      members.forEach((m) => {
        const row = document.createElement("div");

        // ‚≠ê ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤
        row.className = "row";
        if (m.isLeader) {
          row.style.background = "#e6f9e6";  // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô
          row.style.border = "1px solid #8ddb8d";
        }

        const main = document.createElement("div");
        main.className = "row-main";

        let nameLine = m.name;
        if (m.isLeader) nameLine += " (‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡∏°)";

        main.innerHTML = `
      <span>${nameLine}</span>
      <span class='aff-name'>${m.rescueId} ¬∑ ${m.affiliatedUnit}</span>
    `;

        row.appendChild(main);

        // ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (‡πÅ‡∏ï‡πà‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
        if (isLeader && !m.isLeader) {
          const act = document.createElement("div");
          act.className = "row-action";
          act.textContent = "‚úï";
          act.title = "Remove Member";

          act.addEventListener("click", () => {
            showConfirm(`Remove "${m.name}" from team?`, () => removeMember(m.rescueId));
          });

          row.appendChild(act);
        }

        list.appendChild(row);
      });
    }

    /* ---------------------------------------
       Load Members
    ----------------------------------------*/
    async function loadMembers() {
      const viewerId = await ensureCurrentRescueId();

      const r = await fetch(
        `${API_BASE}/api/rescue-teams/${teamId}/members/${viewerId}`,
        {
          headers: { Authorization: "Bearer " + token },
        }
      );

      if (r.status === 403) {
        showMsg("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ó‡∏µ‡∏°‡∏ô‡∏µ‡πâ", true);
        return;
      }

      const data = await r.json();
      renderMembers(data);
    }

    /* ---------------------------------------
       Remove Member (with confirm)
    ----------------------------------------*/
    async function removeMember(rescueId) {
      const leaderId = currentRescueId;

      const r = await fetch(
        `${API_BASE}/api/rescue-teams/${teamId}/members/${rescueId}/remove/${leaderId}`,
        {
          method: "DELETE",
          headers: { Authorization: "Bearer " + token },
        }
      );

      if (!r.ok) {
        showMsg("‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", true);
      } else {
        showMsg("‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", false);
        loadMembers();
      }
    }

    /* ---------------------------------------
       Delete Team (with confirm)
    ----------------------------------------*/
    document.getElementById("deleteTeamBtn").addEventListener("click", () => {
      showConfirm("Are you sure you want to delete this team?", async () => {
        const viewerId = currentRescueId;

        const r = await fetch(
          `${API_BASE}/api/rescue-teams/${teamId}/delete/${viewerId}`,
          {
            method: "DELETE",
            headers: { Authorization: "Bearer " + token },
          }
        );

        if (r.ok) {
          alert("Team deleted");
          window.location.href =
            "/pages/rescueTeam.html?token=" + encodeURIComponent(token);
        } else {
          showMsg("‡∏•‡∏ö‡∏ó‡∏µ‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", true);
        }
      });
    });

    /* ---------------------------------------
       Modal: Add Member
    ----------------------------------------*/
    const modal = document.getElementById("modalOverlay");

    document.getElementById("addBtn").addEventListener("click", openModal);
    document.getElementById("closeModal").addEventListener("click", closeModal);

    function openModal() {
      modal.classList.add("show");
      loadAvailableCandidates();
    }

    function closeModal() {
      modal.classList.remove("show");
    }

    /* ---------------------------------------
       Load available candidates (no team)
    ----------------------------------------*/
    async function loadAvailableCandidates() {
      const r = await fetch(`${API_BASE}/api/rescue-teams/available`, {
        headers: { Authorization: "Bearer " + token },
      });

      const data = await r.json();
      const list = document.getElementById("candidateList");
      list.innerHTML = "";

      data.forEach((u) => {
        const item = document.createElement("div");
        item.className = "user-item";
        item.innerHTML = `<strong>${u.name}</strong><br><small>${u.rescueId} ¬∑ ${u.affiliatedUnit}</small>`;
        item.addEventListener("click", () => {
          showConfirm(`Add "${u.name}" to team?`, () => addMember(u.rescueId));
        });

        list.appendChild(item);
      });
    }

    /* ---------------------------------------
       Add Member (with confirm)
    ----------------------------------------*/
    async function addMember(rescueId) {
      const leaderId = currentRescueId;

      const r = await fetch(
        `${API_BASE}/api/rescue-teams/${teamId}/members/${rescueId}/add/${leaderId}`,
        {
          method: "PUT",
          headers: { Authorization: "Bearer " + token },
        }
      );

      if (r.ok) {
        showMsg("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", false);
        closeModal();
        loadMembers();
      } else {
        showMsg("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", true);
      }
    }

    /* ---------------------------------------
       Confirm Popup (Reusable)
    ----------------------------------------*/
    function showConfirm(message, onYesCallback) {
      const overlay = document.getElementById("confirmOverlay");
      const msg = document.getElementById("confirmMessage");
      const yesBtn = document.getElementById("confirmYes");
      const noBtn = document.getElementById("confirmNo");

      msg.textContent = message;
      overlay.classList.add("show");

      // Replace events to avoid duplicates
      const newYes = yesBtn.cloneNode(true);
      yesBtn.parentNode.replaceChild(newYes, yesBtn);

      const newNo = noBtn.cloneNode(true);
      noBtn.parentNode.replaceChild(newNo, noBtn);

      newYes.addEventListener("click", () => {
        overlay.classList.remove("show");
        onYesCallback();
      });

      newNo.addEventListener("click", () => {
        overlay.classList.remove("show");
      });
    }

    /* ---------------------------------------
       Init
    ----------------------------------------*/
    ensureCurrentRescueId().then(loadMembers);

  </script>
</body>

</html>