<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>เลือกตำแหน่งบนแผนที่</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <style>
    :root{
      --blue:#0A53E4;
      --card:#FFFFFF;
      --label:#111827;
      --subtext:#6B7280;
      --input-bg:#EEF1F5;
      --border:#D1D5DB;
      --radius:14px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--blue);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }

    .card{
      width:100%;
      max-width:420px;
      background:var(--card);
      border-radius:18px;
      padding:18px 16px 20px;
      box-shadow:0 10px 26px rgba(0,0,0,.18);
    }

    .title{
      font-size:20px;
      font-weight:800;
      color:#111827;
      margin-bottom:2px;
      text-align:center;
    }
    .subtitle{
      font-size:12px;
      color:var(--subtext);
      text-align:center;
      margin-bottom:14px;
    }

    #map{
      width:100%;
      height:260px;
      border-radius:16px;
      overflow:hidden;
      border:1px solid #D1D5DB;
      margin-bottom:10px;
    }

    .field label{
      display:block;
      font-size:12px;
      font-weight:600;
      color:var(--label);
      margin-bottom:4px;
    }
    .field input{
      width:100%;
      padding:7px 9px;
      border-radius:9px;
      border:1px solid var(--border);
      background:var(--input-bg);
      font-size:12px;
      outline:none;
    }

    .btn-row{
      margin-top:10px;
      display:flex;
      gap:8px;
    }
    button{
      flex:1;
      border:none;
      border-radius:999px;
      padding:10px 14px;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
    }
    .btn-primary{
      background:var(--blue);
      color:#fff;
    }
    .btn-ghost{
      background:#EEF1F5;
      color:#111827;
    }

    .status{
      margin-top:10px;
      font-size:11px;
      color:var(--subtext);
      min-height:14px;
    }

  </style>
</head>
<body>

<div class="card">
  <div class="title">เลือกตำแหน่งบนแผนที่</div>
  <div class="subtitle">แตะบนแผนที่เพื่อปักหมุด</div>

  <div id="map"></div>

  <div class="field">
    <label>Latitude</label>
    <input id="lat" readonly>
  </div>
  <div class="field">
    <label>Longitude</label>
    <input id="lng" readonly>
  </div>

  <div class="field">
    <label>ถนน</label>
    <input id="road" readonly>
  </div>
  <div class="field">
    <label>ตำบล</label>
    <input id="subdistrict" readonly>
  </div>
  <div class="field">
    <label>อำเภอ</label>
    <input id="district" readonly>
  </div>
  <div class="field">
    <label>จังหวัด</label>
    <input id="province" readonly>
  </div>
  <div class="field">
    <label>รหัสไปรษณีย์</label>
    <input id="postcode" readonly>
  </div>

  <div class="btn-row">
    <button class="btn-ghost" id="btn-clear">ลบหมุด</button>
    <button class="btn-primary" id="btn-confirm">ยืนยันตำแหน่งนี้</button>
  </div>

  <div class="status" id="status"></div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<script>
  const API_BASE = "http://localhost:8080";
  const TOKEN_KEY = "authToken";

  const authToken = localStorage.getItem(TOKEN_KEY);

  const map = L.map('map').setView([19.9105, 99.8406], 13);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
  }).addTo(map);

  let marker = null;

  const latInput = document.getElementById("lat");
  const lngInput = document.getElementById("lng");
  const roadInput = document.getElementById("road");
  const subInput = document.getElementById("subdistrict");
  const distInput = document.getElementById("district");
  const provInput = document.getElementById("province");
  const postInput = document.getElementById("postcode");
  const statusEl = document.getElementById("status");

  function setStatus(t){
    statusEl.textContent = t;
  }

 // ✨ Reverse Geocode (ดึงจังหวัด อำเภอ ตำบล ถนน)
function reverseGeocode(lat, lng){
    fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`)
      .then(r => r.json())
      .then(data => {
        if (!data.address){
          setStatus("ไม่พบข้อมูลที่อยู่");
          return;
        }

        const a = data.address;   // ❗ สำคัญที่สุด ต้องมี

        // ถนน
        const road =
          a.road ||
          a.street ||
          a.residential ||
          a.neighbourhood ||
          "";

        // ตำบล (ตำบลจริงมักอยู่ใน suburb หรือ town ของไทย)
        const subdistrict =
          a.suburb ||
          a.village ||
          a.town ||
          a.locality ||
          "";

        // อำเภอ
        const district =
          a.county ||        // อำเภอไทยอยู่ตรงนี้ 90%
          a.city ||          // fallback
          a.region ||        // fallback
          "";

        // จังหวัด
        // จังหวัด (รองรับหลาย key)
// Nominatim ไทยอาจใช้ state, region, province หรือ ISO3166-2-lvl4
let province =
  a.state ||
  a.province ||
  a.region ||
  a["ISO3166-2-lvl4"] ||
  "";

// แปลงชื่อจังหวัดให้เป็นแบบไทยหากเจอภาษาอังกฤษ
if (province === "Chiang Rai" || province === "Chiang Rai Province") {
  province = "เชียงราย";
}


        // ไปรษณีย์
        const postcode = a.postcode || "";

        // แสดงบน UI
        roadInput.value = road;
        subInput.value = subdistrict;
        distInput.value = district;
        provInput.value = province;
        postInput.value = postcode;

        // เตรียมส่ง backend
        window.lastAddress = {
          road,
          subdistrict,
          district,
          province,
          postcode
        };

        setStatus("โหลดข้อมูลที่อยู่สำเร็จ");
      })
      .catch(err => {
        console.error(err);
        setStatus("ไม่สามารถดึงข้อมูลที่อยู่ได้");
      });
}



  // คลิกเพื่อปักหมุด
  map.on("click", function(e){
    const pos = e.latlng;

    if (!marker){
      marker = L.marker(pos, {draggable:true}).addTo(map);
      marker.on("dragend", (ev)=>{
        const p = ev.target.getLatLng();
        latInput.value = p.lat.toFixed(6);
        lngInput.value = p.lng.toFixed(6);
        reverseGeocode(p.lat, p.lng);
      });
    } else {
      marker.setLatLng(pos);
    }

    latInput.value = pos.lat.toFixed(6);
    lngInput.value = pos.lng.toFixed(6);
    reverseGeocode(pos.lat, pos.lng);

  });

  // ลบหมุด
  document.getElementById("btn-clear").onclick = ()=>{
    if (marker){
      map.removeLayer(marker);
      marker = null;
    }
    latInput.value = "";
    lngInput.value = "";
    roadInput.value = "";
    subInput.value = "";
    distInput.value = "";
    provInput.value = "";
    postInput.value = "";
    setStatus("ลบหมุดแล้ว");
  };

  // ยืนยันตำแหน่ง → ส่งไป backend
  document.getElementById("btn-confirm").onclick = async ()=>{

    if (!latInput.value || !lngInput.value){
      setStatus("กรุณาเลือกตำแหน่งก่อน");
      return;
    }

    const addr = window.lastAddress || {};

    const body = {
      latitude: parseFloat(latInput.value),
      longitude: parseFloat(lngInput.value),
      road: addr.road || "",
      subdistrict: addr.subdistrict || "",
      district: addr.district || "",
      province: addr.province || "",
      postcode: addr.postcode || ""
    };

    setStatus("กำลังบันทึก...");

    const res = await fetch(API_BASE + "/api/user-location/home", {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        "Authorization":"Bearer " + authToken
      },
      body: JSON.stringify(body)
    });

    if (!res.ok){
      setStatus("บันทึกล้มเหลว");
      alert("เกิดข้อผิดพลาด");
      return;
    }

    setStatus("บันทึกสำเร็จ");
    alert("บันทึกตำแหน่งบ้านเรียบร้อยแล้ว ✔️");
  };

</script>

</body>
</html>
