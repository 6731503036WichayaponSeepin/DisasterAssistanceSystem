<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root{
      --blue:#0A53E4;
      --card:#FFFFFF;
      --label:#111827;
      --subtext:#6B7280;
      --input-bg:#EEF1F5;
      --border:#D1D5DB;
      --radius:14px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--blue);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }

    .card{
      width:100%;
      max-width:420px;
      background:var(--card);
      border-radius:18px;
      padding:18px 16px 20px;
      box-shadow:0 10px 26px rgba(0,0,0,.18);
    }

    .title{
      font-size:20px;
      font-weight:800;
      color:#111827;
      margin-bottom:2px;
      text-align:center;
    }
    .subtitle{
      font-size:12px;
      color:var(--subtext);
      text-align:center;
      margin-bottom:14px;
    }

    .section-label{
      font-size:13px;
      font-weight:600;
      color:var(--label);
      margin-bottom:6px;
    }

    /* ‡∏Å‡∏•‡πà‡∏≠‡∏á map */
    #map{
      width:100%;
      height:260px;
      border-radius:16px;
      overflow:hidden;
      border:1px solid #D1D5DB;
      margin-bottom:10px;
    }

    .hint{
      font-size:11px;
      color:var(--subtext);
      margin-bottom:8px;
      text-align:center;
    }

    .row{
      display:flex;
      gap:8px;
      margin-bottom:8px;
    }
    .field{
      flex:1;
    }
    .field label{
      display:block;
      font-size:12px;
      font-weight:600;
      color:var(--label);
      margin-bottom:4px;
    }
    .field input{
      width:100%;
      padding:7px 9px;
      border-radius:9px;
      border:1px solid var(--border);
      background:var(--input-bg);
      font-size:12px;
      color:#111827;
      outline:none;
    }
    .field input:focus{
      border-color:var(--blue);
      background:#FFF;
    }

    .address-field{
      margin-top:2px;
    }

    .btn-row{
      margin-top:10px;
      display:flex;
      gap:8px;
    }
    button{
      flex:1;
      border:none;
      border-radius:999px;
      padding:10px 14px;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      transition:transform .08s ease, box-shadow .08s ease, background-color .1s;
    }
    .btn-primary{
      background:var(--blue);
      color:#fff;
      box-shadow:0 8px 16px rgba(10,83,228,.45);
    }
    .btn-primary:active{
      transform:translateY(1px);
      box-shadow:0 4px 10px rgba(0,0,0,.35);
      background:#0842b6;
    }
    .btn-ghost{
      background:#EEF1F5;
      color:#111827;
    }
    .btn-ghost:active{
      background:#E0E4EC;
      transform:translateY(1px);
    }

    .status{
      margin-top:10px;
      font-size:11px;
      color:var(--subtext);
      min-height:14px;
    }

    /* üîç ‡∏™‡πà‡∏ß‡∏ô search */
    .search-box{
      margin-bottom:10px;
    }
    .search-row{
      display:flex;
      gap:8px;
      margin-bottom:4px;
    }
    .search-row input{
      flex:1;
      padding:7px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--input-bg);
      font-size:12px;
      outline:none;
    }
    .search-row input:focus{
      border-color:var(--blue);
      background:#fff;
    }
    .search-row button{
      flex:0 0 auto;
      padding:7px 14px;
      font-size:12px;
    }
    .search-hint{
      font-size:11px;
      color:var(--subtext);
    }
    .search-results{
      margin-top:6px;
      max-height:110px;
      overflow-y:auto;
      border-radius:10px;
      border:1px solid #E5E7EB;
      background:#F9FAFB;
    }
    .search-item{
      padding:6px 8px;
      font-size:11px;
      border-bottom:1px solid #E5E7EB;
      cursor:pointer;
    }
    .search-item:last-child{
      border-bottom:none;
    }
    .search-item:hover{
      background:#E5F0FF;
    }
    .search-item-title{
      font-weight:600;
      color:#111827;
      margin-bottom:2px;
    }
    .search-item-sub{
      color:#6B7280;
    }
    .search-empty{
      padding:6px 8px;
      font-size:11px;
      color:#6B7280;
    }

    @media (max-width:480px){
      .card{
        padding:16px 12px 18px;
        border-radius:16px;
      }
      #map{
        height:250px;
      }
    }
  </style>
</head>
<body>

<div class="card">
  <div class="title">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div>
  <div class="subtitle">‡πÅ‡∏ï‡∏∞‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</div>

  <!-- üîç ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
  <div class="search-box">
    <div class="section-label">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</div>
    <div class="search-row">
      <input id="search-input" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô Mae Fah Luang University, Central Chiang Rai, ‡∏£‡∏û.‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢ ‡∏Ø‡∏•‡∏Ø">
      <button class="btn-primary" id="btn-search">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
    </div>
    <div class="search-hint">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà/‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô/‡∏ï‡∏≥‡∏ö‡∏•/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏±‡πâ‡∏ô</div>
    <div id="search-results" class="search-results" style="display:none;"></div>
  </div>

  <div class="section-label">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div>
  <div id="map"></div>
  <div class="hint">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏∏‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≤‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ</div>

  <div class="row">
    <div class="field">
      <label for="lat">Latitude</label>
      <input id="lat" type="text" readonly placeholder="‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...">
    </div>
    <div class="field">
      <label for="lng">Longitude</label>
      <input id="lng" type="text" readonly placeholder="‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...">
    </div>
  </div>

  <div class="field address-field">
    <label for="address">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</label>
    <input id="address" type="text" readonly placeholder="‡∏£‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà...">
  </div>

  <div class="btn-row">
    <button class="btn-ghost" id="btn-clear">‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î</button>
    <button class="btn-primary" id="btn-confirm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ</button>
  </div>

  <div class="status" id="status"></div>
</div>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin="">
</script>

<script>
  /* ============= CONFIG TOKEN / PATH ============= */
  const API_BASE    = "http://localhost:8080";
  const TOKEN_KEY   = "authToken";
  const ROLE_KEY    = "authRole";
  const PAGE_SIGNIN = "/";

  // ‡∏≠‡πà‡∏≤‡∏ô query param
  function getQueryParam(name){
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
  }

  // case type (‡∏à‡∏£‡∏¥‡∏á ‡πÜ ‡∏à‡∏∞‡∏°‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡πá‡πÑ‡∏î‡πâ)
  const CASE_TYPE = getQueryParam("type") || "SOS";

  // ----- ‡πÇ‡∏´‡∏•‡∏î token -----
  let authToken = localStorage.getItem(TOKEN_KEY);
  let authRole  = localStorage.getItem(ROLE_KEY);

  // ‡∏ñ‡πâ‡∏≤ localStorage ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÅ‡∏ï‡πà URL ‡∏°‡∏µ token ‚Üí ‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏á localStorage
  const urlToken = getQueryParam("token");
  if (!authToken && urlToken) {
    authToken = urlToken;
    localStorage.setItem(TOKEN_KEY, authToken);
  }

  // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ role ‚Üí set ‡πÄ‡∏õ‡πá‡∏ô USER
  if (!authRole) {
    authRole = "USER";
    localStorage.setItem(ROLE_KEY, authRole);
  }

  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ token ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà USER ‚Üí ‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login
  if (!authToken || authRole !== "USER") {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡∏±‡∏ç‡∏ä‡∏µ User ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ");
    window.location.href = PAGE_SIGNIN;
  }

  // üåè ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏ã‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢ / MFU
  const initialLat = 19.9105;
  const initialLng = 99.8406;
  const initialZoom = 13;

  const map = L.map('map').setView([initialLat, initialLng], initialZoom);

  // Base map ‡∏à‡∏≤‡∏Å OpenStreetMap
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let marker = null;

  const latInput    = document.getElementById('lat');
  const lngInput    = document.getElementById('lng');
  const addrInput   = document.getElementById('address');
  const statusEl    = document.getElementById('status');
  const btnClear    = document.getElementById('btn-clear');
  const btnConfirm  = document.getElementById('btn-confirm');

  const searchInput   = document.getElementById('search-input');
  const btnSearch     = document.getElementById('btn-search');
  const searchResults = document.getElementById('search-results');

  function setStatus(msg){
    statusEl.textContent = msg || '';
  }

  function updateInputs(latlng){
    latInput.value = latlng.lat.toFixed(6);
    lngInput.value = latlng.lng.toFixed(6);
    reverseGeocode(latlng.lat, latlng.lng);
  }

  // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ‚Üí ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î
  map.on('click', function(e){
    const latlng = e.latlng;

    if (!marker){
      marker = L.marker(latlng, {draggable:true}).addTo(map);

      marker.on('dragend', function(ev){
        const pos = ev.target.getLatLng();
        updateInputs(pos);
        setStatus('‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß');
      });
    }else{
      marker.setLatLng(latlng);
    }

    updateInputs(latlng);
    setStatus('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß');
  });

  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡πà‡∏≤‡∏ß ‡πÜ ‡∏à‡∏≤‡∏Å Nominatim
  function reverseGeocode(lat, lng){
    addrInput.value = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà...';
    fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`)
      .then(res => res.json())
      .then(data => {
        if (data && data.display_name){
          addrInput.value = data.display_name;
          setStatus('‡∏î‡∏∂‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }else{
          addrInput.value = '';
          setStatus('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì');
        }
      })
      .catch(err => {
        console.error(err);
        addrInput.value = '';
        setStatus('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏î‡πâ');
      });
  }

  // üîç ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ Nominatim (forward geocoding)
  function searchPlace(){
    const q = searchInput.value.trim();
    if (!q){
      setStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡πà‡∏≠‡∏ô');
      return;
    }
    setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...');
    searchResults.style.display = 'none';
    searchResults.innerHTML = '';

    // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢ (countrycodes=th) ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÇ‡∏•‡∏Å ‡∏•‡∏ö‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å
    const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(q)}&limit=7&countrycodes=th`;

    fetch(url)
      .then(res => res.json())
      .then(data => {
        if (!Array.isArray(data) || data.length === 0){
          searchResults.style.display = 'block';
          searchResults.innerHTML = '<div class="search-empty">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>';
          setStatus('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå');
          return;
        }

        searchResults.style.display = 'block';
        searchResults.innerHTML = '';

        data.forEach(item => {
          const div = document.createElement('div');
          div.className = 'search-item';

          const title = document.createElement('div');
          title.className = 'search-item-title';
          title.textContent = item.display_name.split(',')[0] || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà';

          const sub = document.createElement('div');
          sub.className = 'search-item-sub';
          sub.textContent = item.display_name;

          div.appendChild(title);
          div.appendChild(sub);

          div.addEventListener('click', () => {
            const lat = parseFloat(item.lat);
            const lon = parseFloat(item.lon);

            // ‡∏ã‡∏π‡∏°‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á + ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î
            map.setView([lat, lon], 16);

            if (!marker){
              marker = L.marker([lat, lon], {draggable:true}).addTo(map);
              marker.on('dragend', function(ev){
                const pos = ev.target.getLatLng();
                updateInputs(pos);
                setStatus('‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß');
              });
            }else{
              marker.setLatLng([lat, lon]);
            }

            updateInputs({lat: lat, lng: lon});
            addrInput.value = item.display_name;
            setStatus('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡πâ‡∏ß');

            // ‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            searchResults.style.display = 'none';
          });

          searchResults.appendChild(div);
        });

        setStatus('‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ' + data.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
      })
      .catch(err => {
        console.error(err);
        searchResults.style.display = 'block';
        searchResults.innerHTML = '<div class="search-empty">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>';
        setStatus('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏î‡πâ');
      });
  }

  // ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ + ‡∏Å‡∏î Enter
  btnSearch.addEventListener('click', searchPlace);
  searchInput.addEventListener('keydown', function(e){
    if (e.key === 'Enter'){
      e.preventDefault();
      searchPlace();
    }
  });

  // ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î
  btnClear.addEventListener('click', function(){
    if (marker){
      map.removeLayer(marker);
      marker = null;
    }
    latInput.value = '';
    lngInput.value = '';
    addrInput.value = '';
    setStatus('‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß');
  });

  // ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‚Üí ‡∏™‡πà‡∏á‡πÑ‡∏õ backend
  btnConfirm.addEventListener('click', async function () {
    if (!latInput.value || !lngInput.value) {
      setStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô');
      return;
    }

    const lat  = parseFloat(latInput.value);
    const lng  = parseFloat(lngInput.value);
    const addr = addrInput.value || '';

    if (!authToken) {
      setStatus('‡πÑ‡∏°‡πà‡∏û‡∏ö token ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà');
      alert('‡πÑ‡∏°‡πà‡∏û‡∏ö token ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà');
      window.location.href = PAGE_SIGNIN;
      return;
    }

    const payload = {
      latitude: lat,
      longitude: lng,
      address: addr,
      caseType: CASE_TYPE   // SOS / SUSTENANCE (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Ñ‡∏™)
    };

    try {
      setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå...');

      // üü° TODO: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô path ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö controller ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
      const res = await fetch(API_BASE + "/api/location/home", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + authToken
        },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const text = await res.text();
        console.error('Save error:', text);
        setStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (' + res.status + ')');
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + text);
        return;
      }

      const data = await res.json().catch(() => ({}));
      console.log('Saved location:', data);

      setStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
      alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');

      // ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ homeUser ‡∏Å‡πá‡∏ó‡∏≥‡πÑ‡∏î‡πâ:
      // window.location.href = "/pages/homeUser.html";

    } catch (err) {
      console.error(err);
      setStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á');
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á');
    }
  });
</script>

</body>
</html>
