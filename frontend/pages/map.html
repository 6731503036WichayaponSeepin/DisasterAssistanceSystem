<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>เลือกตำแหน่งบนแผนที่</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
  .back-btn{
    font-size:26px;
    cursor:pointer;
    color:#0A53E4;
    margin-bottom:10px;
}



    :root{
      --blue:#0A53E4;
      --card:#FFFFFF;
      --label:#111827;
      --subtext:#6B7280;
      --input-bg:#EEF1F5;
      --border:#D1D5DB;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--blue);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }

    .card{
      width:100%;
      max-width:420px;
      background:var(--card);
      border-radius:18px;
      padding:18px 16px 20px;
      box-shadow:0 10px 26px rgba(0,0,0,.18);
    }

    .title{
      font-size:20px;font-weight:800;color:#111827;text-align:center;margin-bottom:2px;
    }
    .subtitle{
      font-size:12px;color:var(--subtext);text-align:center;margin-bottom:14px;
    }

    /* Search */
    .search-box{margin-bottom:10px;}
    .search-row{
      display:flex;gap:8px;margin-bottom:4px;
    }
    .search-row input{
      flex:1;padding:7px 9px;border-radius:999px;border:1px solid var(--border);
      background:var(--input-bg);font-size:12px;
    }
    .search-row button{
      padding:7px 14px;border-radius:999px;background:var(--blue);color:#fff;border:none;
      font-size:12px;font-weight:600;cursor:pointer;
    }
    .search-results{
      display:none;max-height:110px;overflow-y:auto;background:#fff;border:1px solid #ddd;
      border-radius:8px;margin-top:4px;
    }
    .search-item{padding:6px 10px;font-size:12px;border-bottom:1px solid #eee;cursor:pointer;}
    .search-item:hover{background:#E5F0FF;}
    .search-item:last-child{border-bottom:none;}

    /* Map */
    #map{
      width:100%;height:260px;border-radius:16px;overflow:hidden;
      border:1px solid #D1D5DB;margin-bottom:10px;
    }

    /* Fields */
    .row{display:flex;gap:8px;margin-bottom:10px;}
    .field{flex:1;}
    .field label{
      font-size:12px;font-weight:600;color:var(--label);margin-bottom:4px;display:block;
    }
    .field input{
      width:100%;padding:7px 9px;border-radius:9px;border:1px solid var(--border);
      background:var(--input-bg);font-size:12px;
    }

    /* Buttons */
    .btn-row{display:flex;gap:8px;margin-top:10px;}
    button{
      flex:1;padding:10px;border:none;border-radius:999px;font-size:13px;font-weight:600;
      cursor:pointer;
    }
    .btn-primary{background:var(--blue);color:#fff;}
    .btn-ghost{background:#EEF1F5;color:#111827;}

    /* Status */
    .status{margin-top:10px;font-size:11px;color:var(--subtext);min-height:14px;}


</style>

</head>
<body>
  
  <div class="card">
    
    <div class="back-btn" onclick="history.back()">←</div>

  <div class="title">เลือกตำแหน่งบนแผนที่</div>
  <div class="subtitle">แตะบนแผนที่เพื่อปักหมุด หรือค้นหาสถานที่สำคัญ</div>

  <!-- Search -->
  <div class="search-box">
    <div class="search-row">
      <input id="search-input" type="text" placeholder="เช่น มฟล, รพ.เชียงราย, เซ็นทรัล…">
      <button id="btn-search">ค้นหา</button>
    </div>
    <div id="search-results" class="search-results"></div>
  </div>

  <div id="map"></div>

  <!-- Lat/Lng -->
  <div class="row">
    <div class="field">
      <label>Latitude</label>
      <input id="lat" readonly>
    </div>
    <div class="field">
      <label>Longitude</label>
      <input id="lng" readonly>
    </div>
  </div>

  <!-- Address -->
  <div class="field">
    <label>ที่อยู่โดยประมาณ</label>
    <input id="address" readonly>
  </div>

  <!-- Buttons -->
  <div class="btn-row">
    <button class="btn-ghost" id="btn-clear">ลบหมุด</button>
    <button class="btn-primary" id="btn-confirm">ยืนยันตำแหน่งนี้</button>
  </div>

  <div id="status" class="status"></div>
</div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const API_BASE = "http://localhost:8080";
const TOKEN_KEY = "authToken";
const authToken = localStorage.getItem(TOKEN_KEY);

// ---------------- MAP LAYERS ----------------
const normalLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png");
const satelliteLayer = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"
);

// Map
const map = L.map("map", {
  center: [19.9105, 99.8406],
  zoom: 13,
  layers: [normalLayer]
});

// Toggle base map
L.control.layers(
  {
    "ปกติ (OSM)": normalLayer,
    "ดาวเทียม (Esri)": satelliteLayer
  },
  {}
).addTo(map);

let marker = null;

// Inputs
const latInput = document.getElementById("lat");
const lngInput = document.getElementById("lng");
const addrInput = document.getElementById("address");
const statusEl = document.getElementById("status");

// ---------------- Reverse Geocode (แยกละเอียด) ----------------
function extractAddress(a) {
    let road =
        a.road ||
        a.street ||
        a.residential ||
        a.path ||
        a.footway ||
        null;

    let subdistrict =
        a.suburb ||
        a.village ||
        a.town ||
        a.locality ||
        null;

    let district =
        a.county ||
        a.city_district ||
        a.district ||
        a.city ||
        null;

    let province =
        a.state ||
        a.province ||
        a.region ||
        null;

    let postcode = a.postcode || null;

    return {road, subdistrict, district, province, postcode};
}

// ---------------- Reverse Geocode ----------------
async function reverseGeocode(lat, lng) {
  addrInput.value = "กำลังค้นหาที่อยู่...";

  const res = await fetch(
    `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`
  );
  const json = await res.json();

  if (!json.address) {
    addrInput.value = "";
    return;
  }

  addrInput.value = json.display_name;
  window.lastAddress = extractAddress(json.address);
}

// ---------------- Set Marker ----------------
function setMarker(lat, lng) {
  if (!marker) {
    marker = L.marker([lat, lng], { draggable: true }).addTo(map);
    marker.on("dragend", (e) => {
      const p = e.target.getLatLng();
      updateInputs(p.lat, p.lng);
    });
  } else {
    marker.setLatLng([lat, lng]);
  }
}

// ---------------- Update Inputs ----------------
function updateInputs(lat, lng) {
  latInput.value = lat.toFixed(6);
  lngInput.value = lng.toFixed(6);
  reverseGeocode(lat, lng);
}

// ---------------- Map Click ----------------
map.on("click", (e) => {
  const p = e.latlng;
  setMarker(p.lat, p.lng);
  updateInputs(p.lat, p.lng);
});

// ---------------- Search Suggestion ----------------
const searchInput = document.getElementById("search-input");
const btnSearch = document.getElementById("btn-search");
const searchResults = document.getElementById("search-results");

async function searchPlace() {
  const q = searchInput.value.trim();
  if (!q) return;

  const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(q)}&countrycodes=th&limit=8`;

  const res = await fetch(url);
  const list = await res.json();

  searchResults.innerHTML = "";
  searchResults.style.display = "block";

  list.forEach((item) => {
    const div = document.createElement("div");
    div.className = "search-item";
    div.textContent = item.display_name;
    div.onclick = () => {
      const lat = parseFloat(item.lat);
      const lon = parseFloat(item.lon);
      setMarker(lat, lon);
      updateInputs(lat, lon);
      map.setView([lat, lon], 16);
      searchResults.style.display = "none";
    };
    searchResults.appendChild(div);
  });
}

btnSearch.onclick = searchPlace;
searchInput.onkeyup = () => {
  if (searchInput.value.length >= 2) searchPlace();
};

// ---------------- Clear ----------------
document.getElementById("btn-clear").onclick = () => {
  if (marker) {
    map.removeLayer(marker);
    marker = null;
  }
  latInput.value = "";
  lngInput.value = "";
  addrInput.value = "";
};

// ---------------- Confirm (บันทึก DB) ----------------
document.getElementById("btn-confirm").onclick = async () => {
  if (!latInput.value || !lngInput.value) {
    alert("กรุณาเลือกตำแหน่งก่อน");
    return;
  }

  const addr = window.lastAddress || {};

  const body = {
    latitude: parseFloat(latInput.value),
    longitude: parseFloat(lngInput.value),
    road: addr.road,
    subdistrict: addr.subdistrict,
    district: addr.district,
    province: addr.province,
    postcode: addr.postcode
  };

  const res = await fetch(API_BASE + "/api/user-location/home", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + authToken
    },
    body: JSON.stringify(body)
  });

  if (!res.ok) {
    alert("บันทึกไม่สำเร็จ");
    return;
  }

  alert("บันทึกตำแหน่งสำเร็จ!");
};




</script>

</body>
</html>