<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create team</title>
  <style>
    :root {
      --blue:#0A53E4;
      --red:#D81324;
      --bg:#F3F4F6;
      --card:#FFFFFF;
      --input-bg:#F3F4F6;
      --green:#16A34A;
      --green-press:#12833C;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--red);
      display:flex;
      justify-content:center;
      padding:24px 12px;
    }
    .phone{
      width:100%;
      max-width:440px;
      border-radius:26px;
      overflow:hidden;
      background:#fff;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      min-height:640px;
      display:flex;
      flex-direction:column;
    }
    .header{
      background:var(--blue);
      color:#fff;
      padding:16px 20px 18px;
      position:relative;
      text-align:center;
      font-weight:700;
      font-size:22px;
    }
    .back{
      position:absolute;
      left:16px;
      top:50%;
      transform:translateY(-50%);
      font-size:20px;
      cursor:pointer;
    }
    .content{
      flex:1;
      background:#fff;
      padding:24px 26px 32px;
    }
    .field{
      margin-bottom:18px;
    }
    label{
      display:block;
      font-size:13px;
      margin-bottom:6px;
      color:#111827;
    }
    input,select{
      width:100%;
      height:40px;
      border-radius:8px;
      border:none;
      background:var(--input-bg);
      padding:0 10px;
      font-size:14px;
      outline:none;
    }
    .btn{
      margin-top:26px;
      width:100%;
      height:44px;
      border-radius:8px;
      border:none;
      background:var(--green);
      color:#fff;
      font-weight:600;
      cursor:pointer;
      font-size:15px;
    }
    .btn:active{background:var(--green-press);}
    .msg{
      margin-top:10px;
      font-size:13px;
    }
    .msg.error{color:#DC2626;}
    .msg.ok{color:#16A34A;}
  </style>
</head>
<body>
<div class="phone">
  <div class="header">
    <span class="back" id="backBtn">←</span>
    Create team
  </div>

  <div class="content">
    <div class="field">
      <label for="teamName">Name</label>
      <input id="teamName" type="text" placeholder="เช่น ทีมแม่สาย 01" />
    </div>

    <div class="field">
      <label for="district">District</label>
      <select id="district">
        <option value="">เลือกอำเภอ</option>
      </select>
    </div>

    <button id="confirmBtn" class="btn">Confirm</button>
    <div id="msg" class="msg"></div>
  </div>
</div>

<script>
const API_BASE = "http://localhost:8080";
const CHIANGRAI_PROVINCE_ID = 1;

// เก็บ token จาก URL ถ้ามี
(function syncTokenFromUrl(){
  const p = new URLSearchParams(window.location.search);
  const t = p.get("token");
  if (t) localStorage.setItem("authToken", t);
})();

let leaderRescueId = localStorage.getItem("rescueId") || null;
const rescueDbId = localStorage.getItem("rescueDbId");
const token = localStorage.getItem("authToken");

if (!token || !rescueDbId){
  window.location.href = "/pages/signin.html?error=need_login";
}

// ดึง rescueId ของตัวเอง ถ้าใน localStorage ยังไม่มี
async function ensureLeaderRescueId(){
  if (leaderRescueId) return leaderRescueId;

  const res = await fetch(`${API_BASE}/api/rescues/main/${rescueDbId}`,{
    headers:{ "Authorization":"Bearer "+token }
  });
  if(!res.ok){
    alert("โหลดข้อมูลกู้ภัยไม่ได้ ("+res.status+")");
    throw new Error("cannot load rescue main");
  }
  const data = await res.json();
  leaderRescueId = data.rescueId;
  localStorage.setItem("rescueId", leaderRescueId);
  return leaderRescueId;
}

// โหลดรายชื่ออำเภอ
async function loadDistricts(){
  try{
    const res = await fetch(`${API_BASE}/api/location/districts/${CHIANGRAI_PROVINCE_ID}`,{
      headers:{ "Authorization":"Bearer "+token }
    });
    if(!res.ok) throw new Error(res.status);
    const districts = await res.json();
    const sel = document.getElementById("district");
    districts.forEach(d=>{
      const opt = document.createElement("option");
      opt.value = d.id;
      opt.textContent = d.name;
      sel.appendChild(opt);
    });
  }catch(err){
    console.error(err);
    showMsg("โหลดรายชื่ออำเภอไม่สำเร็จ",true);
  }
}

function showMsg(text,isError){
  const el = document.getElementById("msg");
  el.textContent = text;
  el.className = "msg " + (isError?"error":"ok");
}

// สร้าง teamId แบบง่าย ๆ (ตัวอย่าง)
function generateTeamId(){
  const num = Math.floor(10000 + Math.random()*90000);
  return "T-" + num;
}

document.getElementById("backBtn").addEventListener("click",()=>{
  window.location.href = "/pages/rescueTeam.html?token="+encodeURIComponent(token);
});

document.getElementById("confirmBtn").addEventListener("click", async ()=>{
  const name = document.getElementById("teamName").value.trim();
  const districtId = document.getElementById("district").value;

  if(!name || !districtId){
    showMsg("กรุณากรอกชื่อทีมและเลือกอำเภอ",true);
    return;
  }

  showMsg("กำลังสร้างทีม...",false);
  document.getElementById("confirmBtn").disabled = true;

  try{
    const leaderId = await ensureLeaderRescueId();
    const teamId = generateTeamId();

    const res = await fetch(`${API_BASE}/api/rescue-teams/create/${leaderId}`,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer "+token
      },
      body:JSON.stringify({
        name: name,
        teamId: teamId,
        districtId: districtId
      })
    });

    if(!res.ok){
      const j = await res.json().catch(()=>({}));
      showMsg(j.message || ("สร้างทีมไม่สำเร็จ ("+res.status+")"),true);
      document.getElementById("confirmBtn").disabled = false;
      return;
    }

    const data = await res.json();
    const finalTeamId = data.teamId || teamId;
    const districtName = (data.district && data.district.name) || 
                         document.getElementById("district").selectedOptions[0].textContent;

    showMsg("สร้างทีมสำเร็จ กำลังเลือกสมาชิก...",false);

    // ไปหน้าเลือกสมาชิก
    const url = `/pages/selectMember.html?token=${encodeURIComponent(token)}&teamId=${encodeURIComponent(finalTeamId)}&district=${encodeURIComponent(districtName)}&isLeader=true`;
    setTimeout(()=>{ window.location.href = url; },700);

  }catch(err){
    console.error(err);
    showMsg("เกิดข้อผิดพลาดในการเชื่อมต่อเซิร์ฟเวอร์",true);
    document.getElementById("confirmBtn").disabled = false;
  }
});

loadDistricts();
ensureLeaderRescueId().catch(()=>{});
</script>
</body>
</html>